{% extends 'base.html' %}
{% load static %}

{% block title %}
Profile
{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}" />
{% endblock %}

{% block content %}
<div class="profile-container-container">
    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-image">
                <img src="{{ MEDIA_URL }}{{ profile_picture }}"
                    alt="Profile Image" />
            </div>
            <div class="profile-info">
                <h2>{{ nickname }}</h2>
                <p>
                    Участник с: <span>{{ date_joined }}</span>
                </p>
            </div>
            {% if user.id == user_id %}
            <div class="logout">
                <div class="indentation">
                    <a href="{% url 'logout' user.id %}"><button>Выйти</button></a>
                </div>
            </div>
            {% endif %}
        </div>
        <hr />
        <div class="profile-stats">
            <div class="stat">
                <h3>Выполнено заданий</h3>
                <p>{{ completedTask_count }}</p>
            </div>
            <div class="stat">
                <h3>Интересы</h3>
                <p>2</p>
            </div>
            <div class="stat">
                <h3>Друзья</h3>
                <p>20</p>
            </div>
        </div>
        <div class="profile-interests">
            <h2>Интересы:</h2>
            <div class="interests-list">
                <div class="interest-box-shadow">
                    <div class="interest-box-border">
                        <div class="interest-box">
                            <div class="image-container">
                                <img src="https://avatars.mds.yandex.net/i?id=743664af1475046ddf9fe5149eeee155_l-9065887-images-thumbs&n=13"
                                    alt="Technology" />
                            </div>
                            <div class="label">Технологии</div>
                        </div>
                    </div>
                </div>
                <div class="interest-box-shadow">
                    <div class="interest-box-border">
                        <div class="interest-box">
                            <div class="image-container">
                                <img src="https://avatars.mds.yandex.net/i?id=73aa7bee9641f1d37382e5813e3841bf_l-4575585-images-thumbs&n=13"
                                    alt="Creative" />
                            </div>
                            <div class="label">Искусство</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="events">
            <h2>Список выполненных заданий:</h2>
            <ul class="task-list">
                {% for completedTask in completedTasks %}
                <li class="task-item">
                    Задание {{completedTask.task.id}} - {{completedTask.task.description}} 
                    <span class="task-date"> 
                        {% if user.id == user_id %}
                        <a href="javascript:void(0);" 
                        onclick="openModal({{ completedTask.task.id }})" 
                        style="color: aqua;">
                        Подтверждено: {{ completedTask.confirmed }}
                        </a>
                        {% else %}
                        <span style="color: gray; cursor: not-allowed;">
                            Подтверждено: {{ completedTask.confirmed }}
                        </span>
                        {% endif %}
                        - {{completedTask.completed_when}}
                    </span>
                </li>
                {% endfor %}
            </ul>
        </div>           
    </div>
</div>
<div class="modal-container" id="confirmation-modal">
    <div class="modal-content">
        <h3>Подтвердите выполнение задания</h3>
        <form id="confirmation_form" method="POST" action="" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <input type="hidden" name="task_id" value=""> <!-- Значение будет установлено через JS -->
        
            <label for="upload">Загрузите подтверждение:</label>
            <input type="file" name="confirmation" id="upload" required />
        
            <label for="description">Добавьте описание:</label>
            <textarea name="description" id="description" placeholder="Напишите описание к подтверждению..." required></textarea>
        
            <div class="modal-buttons">
                <button type="submit">Подтвердить</button>
                <button type="button" class="modal-close">Отмена</button>
            </div>
        </form>        
    </div>
</div>


<script>
function openModal(taskId) {
    const modal = document.getElementById("confirmation-modal");
    modal.classList.add("active");

    // Найти скрытое поле task_id в форме и установить его значение
    const taskIdInput = document.querySelector("#confirmation_form input[name='task_id']");
    taskIdInput.value = taskId;
}

document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("confirmation-modal");
    const closeModalButtons = document.querySelectorAll(".modal-close");
    const taskLinks = document.querySelectorAll(".task-date a");

    // Закрыть модальное окно (по кнопке "Отмена")
    closeModalButtons.forEach(button => {
        button.addEventListener("click", function () {
            modal.classList.remove("active");
        });
    });

    // Закрыть модальное окно (по клику вне области окна)
    modal.addEventListener("click", function (e) {
        if (e.target === modal) {
            modal.classList.remove("active");
        }
    });

    // Закрыть модальное окно (по нажатию Esc)
    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && modal.classList.contains("active")) {
            modal.classList.remove("active");
        }
    });
});

// Функция для получения CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken'); // Получаем CSRF токен

document.getElementById('confirmation_form').addEventListener('submit', function (event) {
    event.preventDefault(); // Предотвращаем стандартное поведение формы

    const modal = document.getElementById("confirmation-modal");
    const form = event.target;
    const formData = new FormData(form); // Создаем объект FormData из формы

    const baseUrl = window.location.origin;
    const changeUrl = "{% url 'confirmation_task' user.id %}";
    const url = new URL(changeUrl, baseUrl);

    fetch(url, {
        method: "POST",
        headers: {
            'X-CSRFToken': csrftoken // Добавляем CSRF токен в заголовки
        },
        body: formData // Передаем FormData как тело запроса
    })
        .then(response => {
            if (!response.ok) { // Проверяем, что запрос успешен
                return response.json().then(errorData => {
                    return Promise.reject(new Error(errorData.message));
                });
            }
            return response.json(); // Парсим успешный ответ
        })
        .then(data => {
            alert("Подтверждение успешно отправлено!");
            modal.classList.remove("active"); // Закрываем модальное окно
            window.location.reload(); // Перезагружаем страницу
        })
        .catch(error => {
            alert("Ошибка отправки подтверждения: " + error.message);
        });
});


</script>

{% endblock %}