{% extends 'base.html' %}
{% load static %}

{% block title %}
Profile
{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}" />
{% endblock %}

{% block content %}

<div class="profile-container-container">
    <div class="profile-container">

        <div>
            <div class="grid grid-cols-2 gap-3">
                <div class="flex-1 logout logout-mobile-ver container">
                    <div class="indentation text-center">
                        <a href="{% url 'settings' user.id %}"><button>Настройки</button></a>
                    </div>
                </div>

                <div class="flex-1 logout logout-mobile-ver container">
                    <div class="indentation text-center">
                        <button class="dropbtn" onclick="toggleDropdown()">
                           Уведомления
                            <!-- <svg aria-hidden="true" aria-label="" class="BNH gUZ U9O kVc" height="12" role="img"
                                viewBox="0 0 24 24" width="12">
                                <path fill="white"
                                    d="M20.16 6.65 12 14.71 3.84 6.65a2.27 2.27 0 0 0-3.18 0 2.2 2.2 0 0 0 0 3.15L12 21 23.34 9.8a2.2 2.2 0 0 0 0-3.15 2.26 2.26 0 0 0-3.18 0">
                                </path>
                            </svg> -->
                        </button>
                    </div>
                </div>

                {% if user.id == user_id %}
                <div class="flex-1 logout logout-mobile-ver container">
                    <div class="indentation text-center">
                        <a href="{% url 'logout' user.id %}"><button>Выйти</button></a>
                    </div>
                </div>
                {% endif %}

                {% if user.is_superuser %}
                <div class="flex-1 logout logout-mobile-ver container">
                    <div class="indentation text-center">
                        <a href="{% url 'admin/users' %}"><button>Админ</button></a>
                    </div>
                </div>
                {% endif %}
            </div>

            <script>
                function toggleDropdown() {
                    const dropdown = document.querySelector('.dropdown');
                    const notificationMenu = document.querySelector('.notification');
        
                    // Закрываем уведомления, если они открыты
                    if (notificationMenu.classList.contains('active')) {
                        toggleNotificationMenu(false);
                    }
        
                    if (dropdown.classList.contains('active')) {
                        dropdown.classList.add('closed');
                        dropdown.addEventListener("animationend", function handleAnimationEnd() {
                            dropdown.classList.remove("active");
                            dropdown.classList.remove('closed');
                            dropdown.removeEventListener("animationend", handleAnimationEnd);
                        });
                    } else {
                        dropdown.classList.add('active');
                    }
                }
        
                function toggleNotificationMenu(forceClose = null) {
                    const menu = document.querySelector('.notification');
                    const dropdown = document.querySelector('.dropdown');
        
                    // Закрываем выпадающее меню профиля, если оно открыто
                    if (dropdown.classList.contains('active')) {
                        toggleDropdown();
                    }
        
                    if (forceClose === true) {
                        menu.classList.remove('active');
                        return;
                    }
        
                    if (menu.classList.contains('active')) {
                        menu.classList.remove('active');
                        menu.classList.add('closed');
                        menu.addEventListener("animationend", function handleAnimationEnd() {
                            menu.classList.remove('closed');
                            menu.removeEventListener("animationend", handleAnimationEnd);
                        });
                    } else {
                        menu.classList.add('active');
                    }
                }
        
                // Закрытие меню при клике вне его
                window.onclick = function (event) {
                    const dropdown = document.querySelector('.dropdown');
                    const notificationMenu = document.querySelector('.notification');
                    const isNotificationClick = event.target.matches('.notification, .notification i');
                    const isDropdownClick = event.target.matches('.dropbtn, .dropbtn *');
        
                    if (!isDropdownClick && dropdown.classList.contains('active')) {
                        toggleDropdown();
                    }
        
                    if (!isNotificationClick && notificationMenu.classList.contains('active')) {
                        toggleNotificationMenu();
                    }
                };
            </script>

            <div class="profile-header">
                <div class="profile-image">
                    <img src="https://sh22-vologda-r19.gosweb.gosuslugi.ru/netcat_files/8/148/net_foto.jpg"
                        alt="Profile Image" />
                </div>
                <div class="profile-info">
                    <h2>{{ nickname }}</h2>
                    <p>
                        Участник с:<br><span>{{ date_joined }}</span>
                    </p>
                </div>
                {% if user.id == user_id %}
                <div class="logout logout-full-ver">
                    <div class="indentation">
                        <a href="{% url 'logout' user.id %}"><button>Выйти</button></a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <hr />
        <div class="profile-stats">
            <div class="stat">
                <h3>Выполнено заданий</h3>
                <p>5</p>
            </div>
            <div class="stat">
                <h3>Интересы</h3>
                <p>2</p>
            </div>
            <div class="stat">
                <h3>Друзья</h3>
                <p>20</p>
            </div>
        </div>
        <div class="profile-interests">
            <h2>Интересы:</h2>
            <div class="interests-list">
                <div class="interest-box-shadow">
                    <div class="interest-box-border">
                        <div class="interest-box">
                            <div class="image-container">
                                <img src="https://avatars.mds.yandex.net/i?id=743664af1475046ddf9fe5149eeee155_l-9065887-images-thumbs&n=13"
                                    alt="Technology" />
                            </div>
                            <div class="label">Технологии</div>
                        </div>
                    </div>
                </div>
                <div class="interest-box-shadow">
                    <div class="interest-box-border">
                        <div class="interest-box">
                            <div class="image-container">
                                <img src="https://avatars.mds.yandex.net/i?id=73aa7bee9641f1d37382e5813e3841bf_l-4575585-images-thumbs&n=13"
                                    alt="Creative" />
                            </div>
                            <div class="label">Искусство</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="events">
            <h2>Список выполненных заданий:</h2>
            <ul class="task-list">
                {% for completedTask in completedTasks %}
                <li class="task-item">
                    Задание {{completedTask.task.id}} - {{completedTask.task.description}} <span class="task-date"> <a href="javascript:void(0);" onclick="openModal()" style="color: aqua;">Подтверждено: {{completedTask.confirmed}}</a>
                        - {{completedTask.completed_when}}</span>
                </li>
                {% endfor %}
            </ul>
        </div>    
    </div>
</div>
<div class="modal-container" id="confirmation-modal">
    <div class="modal-content">
        <h3>Подтвердите выполнение задания</h3>
        <form method="POST" action="" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="upload-image">Загрузите изображение подтверждения:</label>
            <input type="file" name="confirmation_image" id="upload-image" accept="image/png, image/mp4, image/jpeg" required />
            <label for="image-description">Добавьте описание:</label>
            <textarea name="image_description" id="image-description" placeholder="Напишите описание к загруженному изображению..." required></textarea>
            
            <div class="modal-buttons">
                <button type="submit">Подтвердить</button>
                <button type="button" class="modal-close">Отмена</button>
            </div>
        </form>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("confirmation-modal");
    const closeModalButtons = document.querySelectorAll(".modal-close");
    const taskLinks = document.querySelectorAll(".task-date a");

    // Открыть модальное окно
    taskLinks.forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            modal.classList.add("active");
        });
    });

    // Закрыть модальное окно (по кнопке "Отмена")
    closeModalButtons.forEach(button => {
        button.addEventListener("click", function () {
            modal.classList.remove("active");
        });
    });

    // Закрыть модальное окно (по клику вне области окна)
    modal.addEventListener("click", function (e) {
        if (e.target === modal) {
            modal.classList.remove("active");
        }
    });

    // Закрыть модальное окно (по нажатию Esc)
    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && modal.classList.contains("active")) {
            modal.classList.remove("active");
        }
    });
});


</script>

{% endblock %}